# Module 4: Plugins & Marketplace Architecture

**Duration: ~45 minutes**
**Format:** Hands-on Workshop

---

## What You'll Learn

- How to create a `create-plugin` skill that packages components into installable plugins
- How to create a `create-marketplace` skill that builds a marketplace catalogue
- How to package the feature lifecycle components from Module 2 into a plugin
- How to register the plugin in a marketplace and publish it to a Git repo
- How to install plugins from a marketplace into any project

## Prerequisites

- Completed [Module 2: Key Components](./02_key_components.md) — all skills, agents, and the slash command created
- Completed [Module 3: Marketplace Intro](./03_marketplace_intro.md) — understand what plugins and the marketplace are
- Pre-built `skill-creator` skill available

---

## 1. Overview: What We're Doing (3 min)

In Module 2 you built components. In Module 3 you learned why distributing them matters. Now you'll build the tools to **package** and **distribute** them.

```
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│  1. Build │ ──► │ 2. Package│ ──► │ 3. Publish│ ──► │ 4. Install│
│     ✅    │     │           │     │           │     │           │
│ (Module 2)│     │ THIS      │     │ THIS      │     │ THIS      │
│           │     │ MODULE    │     │ MODULE    │     │ MODULE    │
└───────────┘     └───────────┘     └───────────┘     └───────────┘
```

You'll create two new skills:

| Skill | Purpose |
|-------|---------|
| `create-plugin` | Packages selected components into a plugin with `.claude-plugin/plugin.json` |
| `create-marketplace` | Creates or updates a `.claude-plugin/marketplace.json` catalogue |

Then you'll **use** those skills to package the feature lifecycle and register it in a marketplace.

---

## 2. Create the Create-Plugin Skill (10 min)

This skill lets you select which components to include in a plugin, generalises them to be team-agnostic, and bundles them into a plugin folder with a manifest.

In your Claude Code session, type:

```
/skill-creator Create a skill called "create-plugin"

The skill should:
- Ask the user to provide a name for the new plugin
- Ask the user which components to include in the plugin. The user
  can select any combination of:
  - MCP server configurations (from .mcp.json)
  - Skills (from .claude/skills/)
  - Subagents (from .claude/agents/)
  - Slash commands (from .claude/commands/)
- List the available components in each category so the user can
  choose by name

Once the user selects the components, the skill should:

1. Create the plugin folder structure inside a "plugins/" directory
   at the project root, don't use any other folder. Follow Claude Code's official plugin structure:

   plugins/<plugin-name>/
   ├── .claude-plugin/
   │   └── plugin.json       ← Manifest goes INSIDE .claude-plugin/
   ├── skills/        (if skills selected)
   ├── agents/        (if agents selected)
   ├── commands/      (if commands selected)
   └── mcp/           (if MCP configs selected)

2. For each selected component, read its definition and GENERALISE it
   to be reusable across different teams and tech stacks:
   - Remove hardcoded tech stack references (e.g., "React with TypeScript",
     "FastAPI with Python") from agent and skill instructions
   - Replace them with a step that says "Discover the project's tech
     stack by reading CLAUDE.md and exploring the codebase"
   - Keep the workflow logic, process steps, and methodology intact
   - Keep skill injection references (e.g., skills: tdd-workflow) intact
   This makes the plugin useful for ANY project, not just the Tea Store

3. Copy the generalised components into the plugin folder

4. Generate a .claude-plugin/plugin.json manifest following Claude Code's
   official plugin manifest schema:
   {
     "name": "<plugin-name>",
     "description": "<auto-generated from components>",
     "version": "1.0.0",
     "author": {
       "name": "<ask the user>"
     },
     "commands": ["./commands/"],
     "agents": ["./agents/"],
     "mcpServers": {
       "<server-name>": {
         "command": "<from .mcp.json>",
         "args": ["<from .mcp.json>"]
       }
     }
   }

   Notes on the manifest:
   - "commands" lists paths to command files/directories (relative to plugin root)
   - "agents" lists paths to agent files (relative to plugin root)
   - "mcpServers" declares MCP server configs using ${CLAUDE_PLUGIN_ROOT}
     for paths within the plugin
   - Skills inside skills/ folders with SKILL.md are auto-discovered
     by Claude Code and do not need to be declared in plugin.json

5. Report what was created and where
```

**Review the generated skill:**

```bash
.claude/skills/create-plugin/SKILL.md
```

Verify it includes:
- Interactive component selection across all four types
- Generalisation logic that strips tech stack specifics
- Proper plugin folder structure creation (`plugins/<name>/.claude-plugin/plugin.json`)
- Plugin manifest generation following the official Claude Code schema

---

## 3. Create the Create-Marketplace Skill (10 min)

This skill creates or updates a marketplace catalogue file that lists all available plugins. The marketplace file follows Claude Code's official schema — see the [official documentation](https://code.claude.com/docs/en/plugin-marketplaces) for the full specification.

In your Claude Code session, type:

```
/skill-creator Create a skill called "create-marketplace"

The skill should:
- Scan the plugins/ folder at the project root for all plugin subfolders
- Read each plugin's .claude-plugin/plugin.json manifest
- Create or update a .claude-plugin/marketplace.json file at the project
  root that catalogues all discovered plugins

The marketplace.json format must follow Claude Code's official schema.

REQUIRED fields at the top level:
- "name" — Marketplace identifier (kebab-case, no spaces). This is
  public-facing: users see it when installing plugins
  (e.g., /plugin install my-tool@marketplace-name)
- "owner" — Object with required "name" field and optional "email" field
- "plugins" — Array of plugin entries

OPTIONAL metadata:
- "metadata.description" — Brief marketplace description
- "metadata.version" — Marketplace version
- "metadata.pluginRoot" — Base directory prepended to relative plugin
  source paths. Set this to "./plugins" so source paths in plugin
  entries are relative to the plugins/ directory

PLUGIN ENTRIES — Each plugin in the "plugins" array requires:
- "name" — Plugin identifier (kebab-case, from plugin.json)
- "source" — Where to fetch the plugin from. For plugins in the same
  repo, use a relative path (e.g., "./feature-lifecycle"). When
  pluginRoot is set, the path is relative to that root.

PLUGIN ENTRIES — Optional fields (read from plugin.json if available):
- "description" — Brief plugin description
- "version" — Plugin version (semver)
- "author" — Object with "name" (required) and "email" (optional)
- "commands" — Custom paths to command files or directories
- "agents" — Custom paths to agent files
- "mcpServers" — MCP server configurations or path to MCP config
- "keywords" — Tags for plugin discovery
- "category" — Plugin category for organisation
- "license" — SPDX license identifier (e.g., MIT, Apache-2.0)

Example marketplace.json:
{
  "name": "<ask the user, kebab-case>",
  "owner": {
    "name": "<ask the user for owner/team name>",
    "email": "<ask the user, optional>"
  },
  "metadata": {
    "description": "<ask the user>",
    "version": "1.0.0",
    "pluginRoot": "./plugins"
  },
  "plugins": [
    {
      "name": "<from plugin.json>",
      "source": "./<plugin-folder-name>",
      "description": "<from plugin.json>",
      "version": "<from plugin.json>",
      "author": {
        "name": "<from plugin.json>"
      }
    }
  ]
}

If marketplace.json already exists:
- Read it and merge new plugins into the existing list
- Update entries for plugins that already exist (by name)
- Preserve plugins that are in the file but not in the plugins/ folder

After creating/updating the file, validate the marketplace by
running: /plugin validate .
(or from terminal: claude plugin validate .)

Report the final marketplace contents when done
```

**Review the generated skill:**

```bash
.claude/skills/create-marketplace/SKILL.md
```

Verify it includes:
- Scanning `plugins/` for plugin folders
- Reading `.claude-plugin/plugin.json` from each plugin
- Creating or updating `.claude-plugin/marketplace.json` at the project root
- Correct official schema with `name`, `owner`, `metadata`, and `plugins` array
- Plugin entries with `name` and `source` as required fields
- Merge logic for existing marketplaces
- Validation step using `/plugin validate .`

### Restart and Verify

Restart Claude Code to load both new skills:

```bash
/exit
claude
```

Verify they appear:

```
/skills
```

You should see `create-plugin` and `create-marketplace` alongside your Module 2 skills.

---

## 4. Package the Feature Lifecycle Plugin (10 min)

Now use the `create-plugin` skill to package everything you built in Module 2 into a single plugin.

In your Claude Code session, type:

```
/create-plugin Create a plugin called "feature-lifecycle" that includes:

MCP servers:
- atlassian (the Jira MCP server)

Skills:
- create-ticket
- expand-ticket
- tdd-workflow
- create-branch
- commit-and-merge

Subagents:
- planner
- tdd-implementer
- code-reviewer

Slash commands:
- implement-feature

Author: "<your name>"
```

The skill should:
1. Create `plugins/feature-lifecycle/` with `.claude-plugin/` subfolder
2. Generalise each component (strip Tea Store tech stack references)
3. Copy generalised versions into the plugin folder
4. Generate `.claude-plugin/plugin.json`

### Verify the Plugin

Check the created structure:

```bash
plugins/feature-lifecycle/
├── .claude-plugin/
│   └── plugin.json               ← Manifest inside .claude-plugin/
├── skills/
│   ├── create-ticket/
│   │   └── SKILL.md
│   ├── expand-ticket/
│   │   └── SKILL.md
│   ├── tdd-workflow/
│   │   └── SKILL.md
│   ├── create-branch/
│   │   └── SKILL.md
│   └── commit-and-merge/
│       └── SKILL.md
├── agents/
│   ├── planner.md
│   ├── tdd-implementer.md
│   └── code-reviewer.md
├── commands/
│   └── implement-feature.md
└── mcp/
    └── atlassian.json
```

Open `.claude-plugin/plugin.json` and verify it declares components and the Jira MCP server configuration.

Spot-check a generalised agent (e.g., `planner.md`) — it should say something like "Discover the project's tech stack by reading CLAUDE.md" instead of "React with TypeScript, FastAPI with Python".

### Exercise: Package the Meta Skills Plugin

Now use the `create-plugin` skill again to package the three pre-built creator skills into a separate plugin called `meta-skills`. These are the skills that create other skills, agents, and commands — useful for any team bootstrapping their Claude Code setup.

In your Claude Code session, type:

```
/create-plugin ...
...
```

Verify the created structure:

```bash
plugins/meta-skills/
├── .claude-plugin/
│   └── plugin.json
└── skills/
    ├── skill-creator/
    │   └── SKILL.md
    ├── agent-creator/
    │   └── SKILL.md
    └── command-creator/
        └── SKILL.md
```

You now have **two plugins** in your `plugins/` folder: `feature-lifecycle` and `meta-skills`. Both will be picked up when you create the marketplace in the next section.

---

## 5. Create the Marketplace (5 min)

Now use the `create-marketplace` skill to register both plugins in a marketplace catalogue.

In your Claude Code session, type:

```
/create-marketplace Create a marketplace from the plugins in plugins/

Marketplace name: "pandora-marketplace-demo"
Owner name: "Pandora AI Champions"
Description: "Organisation-level plugins for Pandora development teams"
```

### Verify the Marketplace

Check the generated file:

```bash
.claude-plugin/marketplace.json
```

It should contain two entries — `feature-lifecycle` and `meta-skills` — each with its source path pointing to the plugin folder.

### Current State

```
tea-store-demo/
├── .claude-plugin/
│   └── marketplace.json              ← Marketplace catalogue (2 plugins)
└── plugins/
    ├── feature-lifecycle/            ← Plugin: feature implementation pipeline
    │   ├── .claude-plugin/
    │   │   └── plugin.json
    │   ├── skills/
    │   ├── agents/
    │   ├── commands/
    │   └── mcp/
    └── meta-skills/                  ← Plugin: creator skills for bootstrapping
        ├── .claude-plugin/
        │   └── plugin.json
        └── skills/
```

---

## 6. Publish to a Marketplace Repo (5 min)

> **Note:** In this module you'll understand the publishing process. You do **not** need to push to a remote repo right now.

Publishing means copying the `plugins/` folder and `.claude-plugin/` directory into the marketplace Git repository and pushing.

### The Process

```
Your Project                              Marketplace Repo
                                          (claude_code_marketplace_demo)

.claude-plugin/                ──copy──►  .claude-plugin/
  └── marketplace.json                      └── marketplace.json
plugins/                       ──copy──►  plugins/
  ├── feature-lifecycle/                    ├── feature-lifecycle/
  │   ├── .claude-plugin/                   │   ├── .claude-plugin/
  │   │   └── plugin.json                   │   │   └── plugin.json
  │   ├── skills/                           │   ├── skills/
  │   ├── agents/                           │   ├── agents/
  │   ├── commands/                         │   ├── commands/
  │   └── mcp/                              │   └── mcp/
  └── meta-skills/                          └── meta-skills/
      ├── .claude-plugin/                       ├── .claude-plugin/
      │   └── plugin.json                       │   └── plugin.json
      └── skills/                               └── skills/
```

In practice the steps would be:

1. **Copy** the `plugins/` folder and `.claude-plugin/marketplace.json` into the marketplace repo
2. **Commit** with a message like `feat: add feature-lifecycle and meta-skills plugins v1.0.0`
3. **Tag** the release: `git tag v1.0.0`
4. **Push** to the remote: `git push origin main --tags`

The marketplace repo then becomes the source of truth. Any team can browse `marketplace.json` to see what's available and install what they need.

### Marketplace Repo Structure

After publishing, the marketplace repo looks like:

```
claude_code_marketplace_demo/
├── .claude-plugin/
│   └── marketplace.json
└── plugins/
    ├── feature-lifecycle/
    │   ├── .claude-plugin/
    │   │   └── plugin.json
    │   ├── skills/
    │   ├── agents/
    │   ├── commands/
    │   └── mcp/
    └── meta-skills/
        ├── .claude-plugin/
        │   └── plugin.json
        └── skills/
```

As more plugins are published, the `plugins/` folder grows and `marketplace.json` is updated to include each new entry.

---

## 7. Install Plugins from a Marketplace (5 min)

Now the other side — how a team installs plugins from a published marketplace into their project using the `/plugin` slash command.

A pre-built marketplace is available at:

```
https://github.com/gravity9-tech/claude_code_marketplace_demo
```

### Step 1: Add the Marketplace

Before you can install plugins, you need to register the marketplace with your project. In Claude Code:

```
/plugin marketplace add https://github.com/gravity9-tech/claude_code_marketplace_demo.git
```

This registers the marketplace repository as a plugin source for your project. Claude Code will fetch `.claude-plugin/marketplace.json` from the repo and make all its plugins available for installation.

You only need to add a marketplace **once per project**. After that, all plugins from that marketplace are available. Users can refresh with `/plugin marketplace update`.

### Step 2: Browse Available Plugins

To see what plugins are available from your registered marketplaces:

```
/plugin list
```

This reads the `marketplace.json` from each registered marketplace and shows a catalogue of available plugins with their names, descriptions, and component lists. You should see both `feature-lifecycle` and `meta-skills` listed.

### Step 3: Install Plugins

To install specific plugins from the marketplace:

```
/plugin install feature-lifecycle@pandora-marketplace-demo
/plugin install meta-skills@pandora-marketplace-demo
```

The format is `<plugin-name>@<marketplace-name>`. Claude Code will:
1. Look up the plugin in the marketplace
2. Fetch the plugin contents from the marketplace repo
3. Copy the plugin directory to a local cache
4. Make skills, agents, commands, and MCP servers available in Claude Code

```
feature-lifecycle plugin:
skills/create-ticket/    ──install──►     skills auto-discovered
skills/expand-ticket/    ──install──►     skills auto-discovered
skills/tdd-workflow/     ──install──►     skills auto-discovered
skills/create-branch/    ──install──►     skills auto-discovered
skills/commit-and-merge/ ──install──►     skills auto-discovered
agents/planner.md        ──install──►     agents available
agents/tdd-implementer.md──install──►     agents available
agents/code-reviewer.md  ──install──►     agents available
commands/implement-feature.md──install──► /implement-feature available
mcp/atlassian.json       ──install──►     MCP server configured

meta-skills plugin:
skills/skill-creator/    ──install──►     skills auto-discovered
skills/agent-creator/    ──install──►     skills auto-discovered
skills/command-creator/  ──install──►     skills auto-discovered
```

### Step 4: Verify

Restart Claude Code to load the newly installed components:

```bash
/exit
claude
```

Then verify everything was installed:

```
/skills
```

You should see all five skills from the `feature-lifecycle` plugin and all three skills from the `meta-skills` plugin listed.

### Remove a Plugin

To remove a previously installed plugin:

```
/plugin uninstall feature-lifecycle@pandora-marketplace-demo
```

Claude Code will remove the plugin and its components.

### Quick Reference

| Command | What it does |
|---------|-------------|
| `/plugin marketplace add <owner/repo>` | Register a marketplace repo as a plugin source |
| `/plugin marketplace update` | Refresh all registered marketplaces |
| `/plugin list` | Show available plugins from registered marketplaces |
| `/plugin install <name>@<marketplace>` | Install a plugin from a specific marketplace |
| `/plugin uninstall <name>@<marketplace>` | Remove a previously installed plugin |

> **Tip:** After installing or removing plugins, restart Claude Code (`/exit` then `claude`) to reload the updated skills, agents, and commands.

---

## Architecture Recap

```
┌───────────────────────────────────────────────────────────────┐
│                     PLUGIN LIFECYCLE                          │
│                                                               │
│  ┌──────────┐   ┌──────────────┐   ┌──────────────────────┐   │
│  │  BUILD   │   │   PACKAGE    │   │      PUBLISH         │   │
│  │ (Mod 2)  │──►│ create-plugin│──►│ Copy to marketplace  │   │
│  │          │   │   skill      │   │ repo + git push      │   │
│  └──────────┘   └──────────────┘   └──────────┬───────────┘   │
│                                                │              │
│                                                ▼              │
│                                     ┌──────────────────────┐  │
│                                     │ MARKETPLACE REPO     │  │
│                                     │ .claude-plugin/      │  │
│                                     │   marketplace.json   │  │
│                                     │ plugins/             │  │
│                                     └──────────┬───────────┘  │
│                                                │              │
│                                                ▼              │
│  ┌──────────────────────┐          ┌──────────────────────┐   │
│  │    TARGET PROJECT    │◄─────────│      INSTALL         │   │
│  │ Plugin cached &      │ /plugin  │ /plugin marketplace  │   │
│  │ components available │ install  │   add <owner/repo>   │   │
│  └──────────────────────┘          │ /plugin install      │   │
│                                    │   <name>@<market>    │   │
│                                    └──────────────────────┘   │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## Final Project Structure

After completing this module:

```
tea-store-demo/
├── .claude/
│   ├── agents/                     # From Module 2
│   ├── commands/                   # From Module 2
│   └── skills/
│       ├── skill-creator/          # Pre-built
│       ├── agent-creator/          # Pre-built
│       ├── command-creator/        # Pre-built
│       ├── create-ticket/          # Module 2
│       ├── expand-ticket/          # Module 2
│       ├── tdd-workflow/           # Module 2
│       ├── create-branch/          # Module 2
│       ├── commit-and-merge/       # Module 2
│       ├── create-plugin/          # NEW — packages components
│       └── create-marketplace/     # NEW — builds marketplace catalogue
├── .claude-plugin/
│   └── marketplace.json            # NEW — marketplace catalogue (2 plugins)
├── plugins/
│   ├── feature-lifecycle/          # NEW — feature implementation pipeline plugin
│   │   ├── .claude-plugin/
│   │   │   └── plugin.json
│   │   ├── skills/
│   │   ├── agents/
│   │   ├── commands/
│   │   └── mcp/
│   └── meta-skills/                # NEW — creator skills plugin
│       ├── .claude-plugin/
│       │   └── plugin.json
│       └── skills/
├── .mcp.json
└── CLAUDE.md
```

---

## Key Takeaways

| Concept | What You Did |
|---------|-------------|
| **create-plugin skill** | Built a skill that packages any combination of components into an installable plugin. Used it to create two plugins: `feature-lifecycle` and `meta-skills` |
| **Generalisation** | Stripped tech stack specifics so plugins work across teams |
| **`.claude-plugin/plugin.json`** | Manifest that declares what a plugin provides and requires |
| **create-marketplace skill** | Built a skill that catalogues plugins into `.claude-plugin/marketplace.json` |
| **Publishing** | Copy `plugins/` and `.claude-plugin/` to a Git repo, tag, and push |
| **Installing** | `/plugin marketplace add <owner/repo>` then `/plugin install <name>@<marketplace>` |

### The Two Skills You Built

| Skill | Input | Output |
|-------|-------|--------|
| `create-plugin` | Component selection + plugin name | `plugins/<name>/` with generalised components and `.claude-plugin/plugin.json` |
| `create-marketplace` | Scan `plugins/` | `.claude-plugin/marketplace.json` cataloguing all plugins |

---

## Next Up

Continue to: [05_ralph_loop_and_lisa.md](./05_ralph_loop_and_lisa.md) — Run the Feature Lifecycle Autonomously
